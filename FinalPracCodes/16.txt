-- Problem 16: Library Fine Calculation (MySQL Version)

-- Run this once to create the tables
CREATE TABLE Borrower (
  Rollin INT,
  Name VARCHAR(100),
  DateofIssue DATE,
  NameofBook VARCHAR(200),
  Status CHAR(1) -- 'I' for Issued, 'R' for Returned
);

CREATE TABLE Fine (
  Roll_no INT,
  Fine_Date DATE,
  Amt DECIMAL(10,2)
);

-- Sample Data
INSERT INTO Borrower VALUES 
(101, 'Student A', DATE_SUB(CURDATE(), INTERVAL 20 DAY), 'PL/SQL Basics', 'I'),
(102, 'Student B', DATE_SUB(CURDATE(), INTERVAL 40 DAY), 'Database Design', 'I'),
(103, 'Student C', DATE_SUB(CURDATE(), INTERVAL 5 DAY), 'Java Programming', 'I');

-- Now create the stored procedure
DELIMITER $$

CREATE PROCEDURE calculate_fine(IN p_roll_no INT, IN p_book_name VARCHAR(200))
BEGIN
  DECLARE v_date_of_issue DATE;
  DECLARE v_days_overdue INT;
  DECLARE v_fine_amount DECIMAL(10,2) DEFAULT 0;
  DECLARE no_data_found BOOLEAN DEFAULT FALSE;

  -- 1. Fetch the issue date (handle case where no row exists)
  SELECT DateofIssue INTO v_date_of_issue
  FROM Borrower
  WHERE Rollin = p_roll_no 
    AND NameofBook = p_book_name
    AND Status = 'I'
  LIMIT 1;

  IF v_date_of_issue IS NULL THEN
    SELECT CONCAT('No active issue found for Roll No ', p_roll_no, ' and book "', p_book_name, '".') AS Message;
    LEAVE proc_end;
  END IF;

  -- 2. Calculate days overdue
  SET v_days_overdue = DATEDIFF(CURDATE(), v_date_of_issue);

  -- 3. Calculate fine
  IF v_days_overdue > 30 THEN
    SET v_fine_amount = (30 * 5) + ((v_days_overdue - 30) * 50);
  ELSEIF v_days_overdue >= 15 THEN
    SET v_fine_amount = v_days_overdue * 5;
  ELSE
    SET v_fine_amount = 0;
  END IF;

  -- 4. Update borrower status to 'R'
  UPDATE Borrower
  SET Status = 'R'
  WHERE Rollin = p_roll_no 
    AND NameofBook = p_book_name
    AND Status = 'I';

  -- 5. Insert fine record if applicable
  IF v_fine_amount > 0 THEN
    INSERT INTO Fine (Roll_no, Fine_Date, Amt)
    VALUES (p_roll_no, CURDATE(), v_fine_amount);
  END IF;

  -- 6. Show messages (simulate DBMS_OUTPUT)
  SELECT 
    CONCAT('Book "', p_book_name, '" issued ', v_days_overdue, 
           ' days ago. Fine: Rs ', v_fine_amount) AS Info,
    CONCAT('Book "', p_book_name, '" has been returned.') AS StatusMsg;

  proc_end: BEGIN END;
END$$

DELIMITER ;

CALL calculate_fine(102, 'Database Design');
SELECT * FROM Fine;
SELECT * FROM Borrower;


