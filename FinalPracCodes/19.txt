-- Problem 19: PL/SQL Block to increase salary by 10% for those below
-- average and log the change.

-- --- Setup ---
-- Run this once to create the tables.
/*
CREATE TABLE emp (
  emp_no NUMBER PRIMARY KEY,
  emp_name VARCHAR2(100),
  salary NUMBER(10, 2)
);

CREATE TABLE increment_salary (
  log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  emp_no NUMBER,
  salary NUMBER(10, 2), -- This will store the *new* salary
  increment_date DATE
);

-- Sample Data
INSERT INTO emp VALUES (1, 'Alice', 40000);
INSERT INTO emp VALUES (2, 'Bob', 60000);
INSERT INTO emp VALUES (3, 'Charlie', 80000);
-- Average salary is (40000+60000+80000)/3 = 60000
-- Only Alice (40000) should get a raise.
COMMIT;
*/

-- --- PL/SQL Block ---
SET SERVEROUTPUT ON;

DECLARE
  v_avg_salary  emp.salary%TYPE;
  v_new_salary  emp.salary%TYPE;

  -- Cursor to select all employees earning less than the average
  CURSOR c_emp_below_avg IS
    SELECT emp_no, salary
    FROM emp
    WHERE salary < v_avg_salary
    FOR UPDATE OF salary; -- Locks the rows for update

BEGIN
  -- 1. Calculate the average salary of the organization
  SELECT AVG(salary)
  INTO v_avg_salary
  FROM emp;
  
  DBMS_OUTPUT.PUT_LINE('Average Salary: ' || TO_CHAR(v_avg_salary, '999,999.99'));

  -- 2. Loop through each employee earning less than average
  FOR emp_rec IN c_emp_below_avg LOOP
    
    -- 3. Calculate the new salary (10% increase)
    v_new_salary := emp_rec.salary * 1.10;
    
    -- 4. Update the employee's salary
    UPDATE emp
    SET salary = v_new_salary
    WHERE emp_no = emp_rec.emp_no;
    
    -- 5. Maintain a record in the increment_salary table
    INSERT INTO increment_salary (emp_no, salary, increment_date)
    VALUES (emp_rec.emp_no, v_new_salary, SYSDATE);
    
    DBMS_OUTPUT.PUT_LINE('Updated Employee: ' || emp_rec.emp_no
                         || ', Old Salary: ' || emp_rec.salary
                         || ', New Salary: ' || v_new_salary);
                         
  END LOOP;
  
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('Salary update process complete.');

EXCEPTION
  WHEN OTHERS THEN
    DBMS_OUTPUT.PUT_LINE('An error occurred: ' || SQLERRM);
    ROLLBACK;
END;
/