-- Problem 22: Row Level Trigger on Library table to audit
-- UPDATE and DELETE operations into a Library_Audit table.
-- Note: The prompt's "Before and After" is ambiguous. This implementation
-- uses an 'AFTER' trigger, which is the standard, safe practice for auditing
-- successfully completed DML operations.

-- --- Setup ---
-- Run this once to create the tables.
/*
CREATE TABLE Library (
  id NUMBER PRIMARY KEY,
  book_name VARCHAR2(100),
  status VARCHAR2(50) -- e.g., 'Available', 'Checked Out'
);

CREATE TABLE Library_Audit (
  audit_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
  id_old NUMBER,
  book_name_old VARCHAR2(100),
  status_old VARCHAR2(50),
  operation_type VARCHAR2(10), -- 'UPDATE' or 'DELETE'
  operation_date DATE
);

-- Sample Data
INSERT INTO Library VALUES (101, 'Database Systems', 'Available');
INSERT INTO Library VALUES (102, 'PL/SQL Fundamentals', 'Available');
COMMIT;
*/

-- --- Trigger Definition ---
CREATE OR REPLACE TRIGGER trg_library_audit
  AFTER DELETE OR UPDATE ON Library
  FOR EACH ROW
DECLARE
  v_op_type VARCHAR2(10);
BEGIN
  -- Determine if the operation is UPDATE or DELETE
  IF UPDATING THEN
    v_op_type := 'UPDATE';
  ELSIF DELETING THEN
    v_op_type := 'DELETE';
  END IF;

  -- Insert the OLD values into the audit table
  INSERT INTO Library_Audit (
    id_old,
    book_name_old,
    status_old,
    operation_type,
    operation_date
  )
  VALUES (
    :old.id,
    :old.book_name,
    :old.status,
    v_op_type,
    SYSDATE
  );
  
EXCEPTION
  WHEN OTHERS THEN
    -- Handle trigger errors (e.g., log to a different table)
    DBMS_OUTPUT.PUT_LINE('Error in trg_library_audit: ' || SQLERRM);
END trg_library_audit;
/

-- --- PL/SQL Block to Test the Trigger ---
SET SERVEROUTPUT ON;

BEGIN
  DBMS_OUTPUT.PUT_LINE('--- Updating book 101 ---');
  UPDATE Library
  SET status = 'Checked Out'
  WHERE id = 101;
  
  DBMS_OUTPUT.PUT_LINE('--- Deleting book 102 ---');
  DELETE FROM Library
  WHERE id = 102;
  
  COMMIT;
  DBMS_OUTPUT.PUT_LINE('DML complete. Check Library_Audit table.');
END;
/

-- To see the results:
-- SELECT * FROM Library;
-- SELECT * FROM Library_Audit;